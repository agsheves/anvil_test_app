components: []
container:
  properties:
    html: "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js\"></script>\n  </head>\n  <body class=\"bg-gray-100 p-5 font-sans\">\n    <div class=\"max-w-3xl mx-auto bg-white p-5 rounded-lg shadow-md\">\n      <div class=\"flex flex-wrap gap-2.5 mb-5\">\n        <input id=\"avatarID\" anvil-name=\"avatar-input\" type=\"text\" placeholder=\"Avatar ID\" value=\"josh_lite3_20230714\" \n          class=\"flex-1 min-w-[200px] p-2 border border-gray-300 rounded-md\" />\n        <input id=\"voiceID\" anvil-name=\"voice-input\" type=\"text\" placeholder=\"Voice ID\" value=\"1bd001e7e50f421d891986aad5158bc8\"\n          class=\"flex-1 min-w-[200px] p-2 border border-gray-300 rounded-md\" />\n        <button id=\"startBtn\" anvil-name=\"start-btn\" class=\"px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\">\n          Start\n        </button>\n        <button id=\"closeBtn\" anvil-name=\"close-btn\" class=\"px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors\">\n          Close\n        </button>\n      </div>\n\n      <div class=\"flex flex-wrap gap-2.5 mb-5\">\n        <input id=\"taskInput\" anvil-name=\"task-input\" type=\"text\" placeholder=\"Enter text or use voice\" \n          class=\"flex-1 min-w-[200px] p-2 border border-gray-300 rounded-md\" />\n        <button id=\"voiceBtn\" anvil-name=\"voice-btn\" class=\"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors\">\n          ðŸŽ¤ Voice\n        </button>\n        <button id=\"talkBtn\" anvil-name=\"send-btn\" class=\"px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors\">\n          Send\n        </button>\n      </div>\n\n      <video id=\"mediaElement\" anvil-name=\"video-element\" class=\"w-full max-h-[400px] border rounded-lg my-5\" autoplay></video>\n      <div id=\"status\" anvil-name=\"status-div\" class=\"p-2.5 bg-gray-50 border border-gray-300 rounded-md h-[100px] overflow-y-auto font-mono text-sm\"></div>\n    </div>\n\n    <script>\n      let sessionInfo = null;\n      let room = null;\n      let mediaStream = null;\n      let sessionToken = null;\n      let recognition = null;\n      let isListening = false;\n\n      const statusElement = document.getElementById(\"status\");\n      const mediaElement = document.getElementById(\"mediaElement\");\n      const avatarID = document.getElementById(\"avatarID\");\n      const voiceID = document.getElementById(\"voiceID\");\n      const taskInput = document.getElementById(\"taskInput\");\n\n      function updateStatus(message) {\n        const timestamp = new Date().toLocaleTimeString();\n        statusElement.innerHTML += `[${timestamp}] ${message}<br>`;\n        statusElement.scrollTop = statusElement.scrollHeight;\n      }\n\n      // Speech recognition setup\n      if ('webkitSpeechRecognition' in window) {\n        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();\n        recognition.continuous = false;\n        recognition.interimResults = false;\n        recognition.lang = 'en-US';\n\n        recognition.onresult = function(event) {\n          const transcript = event.results[0][0].transcript;\n          taskInput.value = transcript;\n          updateStatus(`Voice: ${transcript}`);\n          isListening = false;\n          document.getElementById(\"voiceBtn\").textContent = \"ðŸŽ¤ Voice\";\n        };\n\n        recognition.onend = function() {\n          isListening = false;\n          document.getElementById(\"voiceBtn\").textContent = \"ðŸŽ¤ Voice\";\n        };\n      }\n\n      async function createNewSession() {\n        updateStatus(\"Requesting session creation...\");\n\n        try {\n          const sessionData = await anvil.call(statusElement, 'create_heygen_session', avatarID.value, voiceID.value);\n\n          if (sessionData && sessionData.sessionInfo) {\n            sessionInfo = sessionData.sessionInfo;\n            sessionToken = sessionData.sessionToken;\n            setupLiveKitRoom();\n          } else {\n            updateStatus(\"Invalid session data received\");\n          }\n        } catch (error) {\n          console.error(\"Error creating session:\", error);\n          updateStatus(`Error creating session: ${error}`);\n        }\n      }\n\n      async function startStreamingSession() {\n        if (!sessionInfo || !sessionToken) {\n          updateStatus(\"No session info or token available\");\n          return;\n        }\n\n        try {\n          await anvil.call(statusElement, 'start_heygen_session', sessionInfo.session_id, sessionToken);\n          await connectToRoom();\n        } catch (error) {\n          updateStatus(`Error starting session: ${error}`);\n        }\n      }\n\n      async function processAndSendText(text) {\n        if (!text.trim() || !sessionInfo || !sessionToken) return;\n        updateStatus(`Processing: \"${text}\"`);\n\n        try {\n          const response = await anvil.call(statusElement, 'process_user_input', text);\n          if (response) {\n            await anvil.call(statusElement, 'send_text_to_avatar', sessionInfo.session_id, response, sessionToken);\n            updateStatus(`AI: ${response}`);\n          }\n        } catch (error) {\n          updateStatus(`Error processing text: ${error}`);\n        }\n      }\n\n      async function closeSession() {\n        try {\n          if (sessionInfo && sessionToken) {\n            await anvil.call(statusElement, 'close_heygen_session', sessionInfo.session_id, sessionToken);\n          }\n          if (room) room.disconnect();\n          mediaElement.srcObject = null;\n          sessionInfo = null;\n          sessionToken = null;\n          document.querySelector(\"#startBtn\").disabled = false;\n          updateStatus(\"Session closed\");\n        } catch (error) {\n          updateStatus(`Error closing session: ${error}`);\n        }\n      }\n\n      function setupLiveKitRoom() {\n        room = new LivekitClient.Room({\n          adaptiveStream: true,\n          dynacast: true,\n          videoCaptureDefaults: { resolution: LivekitClient.VideoPresets.h720.resolution },\n        });\n\n        mediaStream = new MediaStream();\n        room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {\n          if (track.kind === \"video\" || track.kind === \"audio\") {\n            mediaStream.addTrack(track.mediaStreamTrack);\n            if (mediaStream.getVideoTracks().length > 0 && mediaStream.getAudioTracks().length > 0) {\n              mediaElement.srcObject = mediaStream;\n              updateStatus(\"Media stream ready\");\n            }\n          }\n        });\n\n        room.prepareConnection(sessionInfo.url, sessionInfo.access_token);\n        updateStatus(\"Session created successfully\");\n      }\n\n      async function connectToRoom() {\n        await room.connect(sessionInfo.url, sessionInfo.access_token);\n        document.querySelector(\"#startBtn\").disabled = true;\n        updateStatus(\"Streaming started\");\n      }\n\n      // Event listeners\n      document.querySelector(\"#startBtn\").addEventListener(\"click\", async () => {\n        await createNewSession();\n        await startStreamingSession();\n      });\n\n      document.querySelector(\"#closeBtn\").addEventListener(\"click\", closeSession);\n\n      document.querySelector(\"#voiceBtn\").addEventListener(\"click\", () => {\n        if (!recognition) return;\n        if (isListening) {\n          recognition.stop();\n        } else {\n          recognition.start();\n          isListening = true;\n          document.getElementById(\"voiceBtn\").textContent = \"ðŸ”´ Stop\";\n        }\n      });\n\n      document.querySelector(\"#talkBtn\").addEventListener(\"click\", () => {\n        const text = taskInput.value.trim();\n        if (text) {\n          processAndSendText(text);\n          taskInput.value = \"\";\n        }\n      });\n    </script>\n  </body>\n</html>"
  type: HtmlTemplate
custom_component: true
is_package: true
